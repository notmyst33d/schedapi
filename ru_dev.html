<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <title>Расписание</title>
</head>

<body>
    <div id="main" class="column" style="padding: 16px;">
        <div class="row" style="align-items: center; margin-bottom: 16px; row-gap: 16px;">
            <img class="product-logo">
            <div class="product-name"></div>
        </div>
        <div class="row" style="padding-bottom: 16px; align-items: center;">
            <div id="header" class="header" style="padding-right: 16px">
                Расписание
            </div>
            <select id="group-select">
                <option value="none">Группа</option>
            </select>
        </div>
        <div class="row" style="padding-bottom: 16px; row-gap: 8px; align-items: center;">
            <div class="week-text" style="padding-right: 8px;">Неделя:</div>
            <input class="week-input" style="margin-right: 8px;" type="number" value="1" min="1" placeholder="Неделя" />
            <button id="week-button-custom" class="primary-button" style="margin-right: 8px;">Получить</button>
            <button id="week-button-current" class="primary-button" style="margin-right: 8px;">Текущая неделя</button>
            <button id="week-button-next" class="primary-button">Следующая неделя</button>
        </div>
        <div id="info-container" class="lesser-header" style="padding-bottom: 16px;">
            Выберите группу в списке
        </div>
        <div id="schedule-container">
        </div>
    </div>
    <img id="important" class="hidden" style="width: 100vw; height: 100vh; object-fit: contain; margin-bottom: -4px;">
    <script>
        const url = new URL(window.location.href);
        const apiUrl = url.searchParams.get("api");

        const main = document.getElementById("main");
        const groupSelect = document.getElementById("group-select");
        const weekInput = document.getElementsByClassName("week-input")[0];
        const weekButtonCustom = document.getElementById("week-button-custom");
        const weekButtonCurrent = document.getElementById("week-button-current");
        const weekButtonNext = document.getElementById("week-button-next");
        const infoContainer = document.getElementById("info-container");
        const scheduleContainer = document.getElementById("schedule-container");
        const productName = document.getElementsByClassName("product-name")[0];
        const productLogo = document.getElementsByClassName("product-logo")[0];

        const oneDay = (60 * 60 * 24) * 1000;
        const oneWeek = oneDay * 7;

        const dayMapping = {
            0: "Понедельник",
            1: "Вторник",
            2: "Среда",
            3: "Четверг",
            4: "Пятница",
            5: "Суббота",
        };

        const monthMapping = {
            0: "января",
            1: "февраля",
            2: "марта",
            3: "апреля",
            4: "мая",
            5: "июня",
            6: "июля",
            7: "августа",
            8: "сентября",
            9: "октября",
            10: "ноября",
            11: "декабря",
        };

        function renderHtmlArray(arr) {
            return arr.join("");
        }

        function renderScheduleRow(entries) {
            if (entries.length === 0) {
                return "";
            }

            let rowsHtml = [];

            for (const entry of entries) {
                rowsHtml.push(renderScheduleEntry(entry));
            }

            return `
                <div class="row expand-w" style="gap: 16px">
                    ${renderHtmlArray(rowsHtml)}
                </div>
            `;
        }

        let importantArray = [];
        const importantKeycodes = [66, 76, 65, 90, 69];
        const importantElement = document.getElementById("important");
        function renderScheduleLesson(lesson, index) {
            let lessonType = "";
            let auditorium = "";
            if (lesson.lesson_type !== undefined) {
                lessonType = ` ${lesson.lesson_type.toLowerCase()}`;
            }
            if (lesson.auditorium !== undefined) {
                if (lesson.auditorium === "Актовый зал") {
                    auditorium = `, ${lesson.auditorium.toLowerCase()}`;
                } else {
                    auditorium = `, аудитория ${lesson.auditorium.toLowerCase()}`;
                }
            }
            if (lesson.empty !== undefined) {
                return `<div>${index}. Пусто</div>`;
            } else {
                return `<div>${index}. ${lesson.name}${lessonType}${auditorium}</div>`;
            }
        }

        function renderScheduleEmpty() {
            return "<div>Пусто</div>";
        }

        function renderScheduleEntry(entry) {
            let lessonsHtml = [];

            if (entry.lessons.length === 0) {
                lessonsHtml.push(renderScheduleEmpty());
            }

            let lessonIndex = 1;
            for (const lesson of entry.lessons) {
                lessonsHtml.push(renderScheduleLesson(lesson, lessonIndex));
                lessonIndex += 1;
            }

            return `
                <div class="column card">
                    <div class="card-header">${entry.dayName}</div>
                    ${renderHtmlArray(lessonsHtml)}
                </div>
            `;
        }

        async function renderWeekText(week) {
            const epoch = await getEpoch();
            const weekStartDate = new Date(epoch + (oneWeek * (week - 1)));
            const weekEndDate = new Date(epoch + (oneWeek * (week - 1) + oneDay * 5));
            return `Неделя ${week}, с ${weekStartDate.getDate()} ${monthMapping[weekStartDate.getMonth()]} по ${weekEndDate.getDate()} ${monthMapping[weekEndDate.getMonth()]}`;
        }

        async function getCurrentWeek() {
            let date = new Date();
            //let offset = date.getTimezoneOffset() * 60 * 1000;
            let offset = 0;
            return Math.ceil(((date.valueOf() - await getEpoch() - offset) / 60 / 60 / 24 / 7) / 1000);
        }

        async function updateForWeek(week) {
            infoContainer.innerText = "Получение данных...";

            let totalLength = 0;
            const response = await fetch(`http://${apiUrl}/schedule?week=${week}&group_id=${groupSelect.value}`);
            if (response.status !== 200) {
                infoContainer.innerText = `API выдал ошибку при получении данных`;
                scheduleContainer.innerHTML = "";
                return;
            }

            const days = await response.json();
            for (const day of days) {
                totalLength += day.length;
            }

            if (totalLength === 0) {
                infoContainer.innerText = `Нет данных на неделю ${week}`;
                scheduleContainer.innerHTML = "";
                return;
            }

            let dayIndex = 0;
            let entries = [];
            let rowsHtml = [];
            for (const day of days) {
                if (entries.length === 2) {
                    rowsHtml.push(renderScheduleRow(entries));
                    entries = [];
                }

                if (dayIndex === 6) {
                    break;
                }

                entries.push({
                    dayName: dayMapping[dayIndex],
                    lessons: day,
                });

                dayIndex += 1;
            }

            scheduleContainer.innerHTML = rowsHtml.join(`<div style="padding-bottom: 16px"></div>`);
            infoContainer.innerText = await renderWeekText(week);
        }

        async function getEpoch() {
            let response = await (await fetch(`http://${apiUrl}/epoch?group_id=${groupSelect.value}`)).json();
            return response.epoch;
        }

        Array.prototype.equals = function (other) {
            if (this.length !== other.length) {
                return false;
            }
            for (let i = 0; i < other.length; i++) {
                if (other[i] !== this[i]) {
                    return false;
                }
            }
            return true;
        };

        async function finalizeSetup() {
            productName.innerText = await (await fetch(`http://${apiUrl}/product/name`)).text();
            productLogo.src = `http://${apiUrl}/product/logo.jpg`;

            let groups = await (await fetch(`http://${apiUrl}/groups/list`)).json();
            for (const group of groups) {
                let option = document.createElement("option");
                option.value = group.id;
                option.innerText = group.name;
                groupSelect.appendChild(option);
            }

            weekButtonCustom.addEventListener("click", () => {
                updateForWeek(weekInput.value);
            });

            weekButtonCurrent.addEventListener("click", async () => {
                const week = await getCurrentWeek();
                weekInput.value = week;
                updateForWeek(week);
            });

            weekButtonNext.addEventListener("click", async () => {
                const week = await getCurrentWeek();
                weekInput.value = week + 1;
                updateForWeek(week + 1);
            });

            weekInput.addEventListener("change", () => {
                if (weekInput.value === "blaze") {
                    important.src = `http://${apiUrl}/fun/blaze`;
                    important.classList.remove("hidden");
                    main.classList.add("hidden");
                }
            });

            productLogo.addEventListener("click", () => {
                weekInput.type = "text";
            });

            document.addEventListener("keydown", (event) => {
                if (!importantKeycodes.includes(event.keyCode)) {
                    importantArray = [];
                    return;
                }
                importantArray.push(event.keyCode);
                if (importantArray.equals(importantKeycodes)) {
                    importantArray = [];
                    important.src = `http://${apiUrl}/fun/blaze`;
                    important.classList.remove("hidden");
                    main.classList.add("hidden");
                }
            });
        }

        if (apiUrl === null) {
            infoContainer.innerText = "Параметр api не найден в URL";
            throw new Error("Validation failed");
        }

        finalizeSetup();
    </script>
</body>

</html>
